p2[pred == 0]= NA
image(ximg[,, z = 17],
col=gray(0:64/64),
bg = "black")
image(p2[,,z = 17],
col = alpha("blue", 0.5), add=TRUE)
image(ximg[,, z = 17],
col=gray(0:64/64),
bg = "black")
image(p2[,,z = 17],
col = alpha("blue", 0.75), add=TRUE)
title(main="Automatic Segmentation", col.main="white", cex.main=2,
outer = FALSE)
source('~/Dropbox/CTR/DHanley/CT_Registration/Segmentation/Seg_Figure/Seg_Figure.R')
## set up the plot region:
op <- par(bg = "thistle")
plot(c(100, 250), c(300, 450), type = "n", xlab="", ylab="",
main = "2 x 11 rectangles; 'rect(100+i,300+i,  150+i,380+i)'")
i <- 4*(0:10)
## draw rectangles with bottom left (100, 300)+i
## and top right (150, 380)+i
rect(100+i, 300+i, 150+i, 380+i, col=rainbow(11, start=.7,end=.1))
rect(240-i, 320+i, 250-i, 410+i, col=heat.colors(11), lwd=i/5)
j <- 10*(0:5)
rect(125+j, 360+j,   141+j, 405+j/2, col = c(NA,0),
border = "gold", lwd = 2)
plot(c(100, 200), c(300, 450), type= "n", xlab="", ylab="")
rect(100, 300, 125, 350) # transparent
plot(c(100, 200), c(300, 450), type= "n", xlab="", ylab="", xaxt = "n")
plot(c(100, 200), c(300, 450), type= "n", xlab="", ylab="", axt = "n")
yaxt = "n")
plot(c(100, 200), c(300, 450), type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n")
yaxt = "n", box="n")
plot(c(100, 200), c(300, 450), type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", box="n"
)
?plot
plot(c(100, 200), c(300, 450), type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
plot(c(100, 200), c(300, 400), type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(100, 300, 200, 400) # transparent
plot(c(300, 400), c(100, 200),  type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(100, 300, 200, 400, col = "") # transparent
plot(c(300, 400), c(100, 200),  type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(300, 100, 400,  200,  col = "blue") # transparent
plot(c(300, 325), c(100, 200),  type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(300, 100, 325,  200,  col = "blue") # transparent
plot(c(300, 400), c(100, 200),  type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(300, 100, 325,  200,  col = "red") # transparent
rect(310, 100, 400,  200,  col = "blue") # transparent
green
rect(350, 100, 400,  200,  col = "green") # transparent
plot(c(300, 400), c(100, 200),  type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(300, 100, 325,  200,  col = "black") # transparent
rect(300, 100, 400,  200,  col = "black") # transparent
plot(c(300, 400), c(100, 200),  type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(300, 100, 400,  200,  col = "black") # transparent
rect(300, 100, 400,  200,  col = "red") # transparent
rect(310, 100, 400,  200,  col = "blue") # transparent
rect(350, 100, 400,  200,  col = "green") # transparent
plot(c(300, 400), c(100, 200),  type= "n", xlab="", ylab="", xaxt = "n",
yaxt = "n", bty="n")
rect(300, 100, 400,  200,  col = "black") # transparent
??pander
library(knitr)
knit2html("Pfizer_2015_Talk.Rmd")
system("open ./")
rm(list=ls())
library(fslr)
options(fsl.path='/usr/local/fsl/')
ptpat <- "\\d\\d\\d-(\\d|)\\d\\d\\d"
username <- Sys.info()["user"][[1]]
rootdir <- path.expand(file.path("~/CT_Registration/Final_Brain_Seg"))
basedir = file.path(rootdir, "Original_Images")
outdir = file.path(rootdir, "results")
dirs <- list.dirs(basedir, full.names=TRUE, recursive=FALSE)
dirs <- dirs[!grepl("(Images|programs)$", dirs)]
dirs = dirs[grepl("144-4220", dirs, fixed=TRUE)]
idir = dirs[1]
f.img <- dir(pattern=".*.nii.gz", path=idir,
recursive=FALSE, full.names=TRUE)
f.ssimg = file.path(dirname(f.img), "Skull_Stripped",
paste0(nii.stub(f.img, bn=TRUE), "_SS_0.01.nii.gz"))
img = readNIfTI(f.img, reorient=FALSE)
ssimg = readNIfTI(f.ssimg, reorient=FALSE)
f.img
system("open ./")
getwd()
rm(list=ls())
library(fslr)
library(cttools)
library(scales)
homedir = path.expand("~/CT_Registration/Segmentation/")
outdir = path.expand("~/Oral_Proposal")
datadir = file.path(homedir, "Seg_Figure")
resdir = file.path(homedir, "results")
options(fsl.path='/usr/local/fsl/')
img = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE.nii.gz"),
reorient=FALSE)
ssimg = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_SS_0.01.nii.gz"),
reorient=FALSE)
roi = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINEROI.nii.gz"),
reorient=FALSE)
pred = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_mod_agg_Rigid_prediction_native.nii.gz"),
reorient=FALSE)
pred = cal_img(pred > 0.5)
# mask.overlay(img, pred, window=c(0, 100))
# mask.overlay(img, roi, window=c(0, 100))
d = array(0, dim=dim(pred))
d[pred == 1 & roi == 1] = 1
d[pred == 1 & roi == 0] = 2
d[pred == 0 & roi == 1] = 2
plevs = c("Correct Prediction", "Incorrect Prediction")
d = niftiarr(pred, d)
xyz = cog(roi, ceil = TRUE)
pngname = file.path(resdir, "SS_Image_PrePredict_ROI_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(img, roi,
window=c(0, 100),
xyz=xyz,
text = "Manual\n Segmentation",
text.cex = 2.3
)
dev.off()
pngname = file.path(resdir, "SS_Image_PrePredict_Auto_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(img, pred,
window=c(0, 100),
xyz=xyz,
text = "Automatic\n Segmentation",
text.cex = 2.3
)
dev.off()
pngname = file.path(resdir, "Prediction_Figure_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(ssimg, d, col.y = c("blue", "red"),
window=c(0, 100),
ybreaks = c(0.5, 1.5, 2.5),
addlegend = TRUE,
leg.x = 2, leg.y= 60,
leg.col = c("blue", "red"),
leg.cex=2.3,
leg.title = "Prediction of ICH",
legend=plevs,
xyz=xyz
)
dev.off()
rm(list=ls())
library(fslr)
library(cttools)
library(scales)
homedir = path.expand("~/CT_Registration/Segmentation/")
outdir = path.expand("~/Oral_Proposal/figure")
datadir = file.path(homedir, "Seg_Figure")
resdir = file.path(homedir, "results")
options(fsl.path='/usr/local/fsl/')
img = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE.nii.gz"),
reorient=FALSE)
ssimg = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_SS_0.01.nii.gz"),
reorient=FALSE)
roi = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINEROI.nii.gz"),
reorient=FALSE)
pred = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_mod_agg_Rigid_prediction_native.nii.gz"),
reorient=FALSE)
pred = cal_img(pred > 0.5)
# mask.overlay(img, pred, window=c(0, 100))
# mask.overlay(img, roi, window=c(0, 100))
d = array(0, dim=dim(pred))
d[pred == 1 & roi == 1] = 1
d[pred == 1 & roi == 0] = 2
d[pred == 0 & roi == 1] = 2
plevs = c("Correct Prediction", "Incorrect Prediction")
d = niftiarr(pred, d)
xyz = cog(roi, ceil = TRUE)
pngname = file.path(resdir, "SS_Image_PrePredict_ROI_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(img, roi,
window=c(0, 100),
xyz=xyz,
text = "Manual\n Segmentation",
text.cex = 2.3
)
dev.off()
pngname = file.path(resdir, "SS_Image_PrePredict_Auto_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(img, pred,
window=c(0, 100),
xyz=xyz,
text = "Automatic\n Segmentation",
text.cex = 2.3
)
dev.off()
pngname = file.path(resdir, "Prediction_Figure_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(ssimg, d, col.y = c("blue", "red"),
window=c(0, 100),
ybreaks = c(0.5, 1.5, 2.5),
addlegend = TRUE,
leg.x = 2, leg.y= 60,
leg.col = c("blue", "red"),
leg.cex=2.3,
leg.title = "Prediction of ICH",
legend=plevs,
xyz=xyz
)
dev.off()
proi = roi
proi[roi == 0]= NA
ppred = pred
ppred[pred == 0]= NA
plevs2 = c("False Negative", "False Positive", "True Positive")
ximg = window_img(img, window=c(0, 100), replace = "window")
pngname = file.path(resdir, "ManAuto_Figure_Slice_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
par( oma = rep(0, 4), mar = c(0, 1, 2, 1), bg = "black", xpd=TRUE)
yind = 100:(512-60)
xind = 100:(512-120)
xx = ximg[,, z = 23][xind, yind]
X = nrow(xx)
Y = ncol(xx)
image(1:X, 1:Y, xx,
# image(ximg[,, z = 23][xind, yind],
col=gray(0:64/64),
bg = "black")
proi.mat = proi[,,z = 23][xind, yind]
ppred.mat = ppred[,,z = 23][xind, yind]
both = proi.mat * ppred.mat
cpred = !(ppred.mat %in% 1 & !(proi.mat %in% 1))
croi = !(proi.mat %in% 1 & !(ppred.mat %in% 1))
ppred.mat[ cpred ] = NA
proi.mat[ croi ] = NA
image(1:X, 1:Y, both,
col = alpha('purple', 0.65), add=TRUE)
image(1:X, 1:Y, proi.mat,
col = alpha('red', 0.65), add=TRUE)
image(1:X, 1:Y, ppred.mat,
col = alpha('blue', 0.65), add=TRUE)
# title(main="Automatic Segmentation", col.main="white", cex.main=2,
#       outer = FALSE)
legend(x = 40,
y= 50,
col = c("red", "blue", "purple"),
border = "black",
bg = "black",
text.col = "white",
lty = rep(1, 3),
lwd = 10,
cex=1,
horiz = TRUE,
legend=plevs2)
# text(0.5, .95, label="Automatic Segmentation", col="white", cex=2)
dev.off()
#####################################################
#
#####################################################
pngname = file.path(outdir, "Original_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(img, window=c(0, 100), text = "Original Image")
dev.off()
outdir
outdir = path.expand("~/CT_RegistrationOral_Proposal/figure")
outdir = path.expand("~/CT_Registration/Oral_Proposal/figure")
dev.off()
pngname = file.path(outdir, "Original_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(img, window=c(0, 100), text = "Original Image")
dev.off()
thresh =  fslthresh(img, thresh = 0, uthresh = 100,
retimg = TRUE)
pngname = file.path(outdir, "Thresh_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(thresh, window=c(0, 100), text = "Thresholded Image")
dev.off()
smooth = fslsmooth(thresh, retimg=TRUE, sigma = 1)
pngname = file.path(outdir, "Smooth_Thresh_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(smooth, window=c(0, 100), text = "Smoothed\nThresholded Image")
dev.off()
pngname = file.path(outdir, "SS_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(ssimg, window=c(0, 100), text = "Brain-Extracted\n Image")
dev.off()
#####################################################
# Standardize the html
#####################################################
pngname = file.path(outdir, "Original_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(img, window=c(0, 100), text = "Original Image", xyz=xyz)
dev.off()
thresh =  fslthresh(img, thresh = 0, uthresh = 100,
retimg = TRUE)
pngname = file.path(outdir, "Thresh_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(thresh, window=c(0, 100), text = "Thresholded Image", xyz=xyz)
dev.off()
smooth = fslsmooth(thresh, retimg=TRUE, sigma = 1)
pngname = file.path(outdir, "Smooth_Thresh_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(smooth, window=c(0, 100), text = "Smoothed\nThresholded Image", xyz=xyz)
dev.off()
pngname = file.path(outdir, "SS_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(ssimg, window=c(0, 100), text = "Brain-Extracted\n Image", xyz=xyz)
dev.off()
rm(list=ls())
library(fslr)
library(cttools)
library(scales)
homedir = path.expand("~/CT_Registration/Segmentation/")
outdir = path.expand("~/CT_Registration/Oral_Proposal/figure")
datadir = file.path(homedir, "Seg_Figure")
resdir = file.path(homedir, "results")
options(fsl.path='/usr/local/fsl/')
img = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE.nii.gz"),
reorient=FALSE)
ssimg = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_SS_0.01.nii.gz"),
reorient=FALSE)
roi = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINEROI.nii.gz"),
reorient=FALSE)
pred = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_mod_agg_Rigid_prediction_native.nii.gz"),
reorient=FALSE)
pred = cal_img(pred > 0.5)
# mask.overlay(img, pred, window=c(0, 100))
# mask.overlay(img, roi, window=c(0, 100))
d = array(0, dim=dim(pred))
d[pred == 1 & roi == 1] = 1
d[pred == 1 & roi == 0] = 2
d[pred == 0 & roi == 1] = 2
plevs = c("Correct Prediction", "Incorrect Prediction")
d = niftiarr(pred, d)
xyz = cog(roi, ceil = TRUE)
pngname = file.path(resdir, "SS_Image_PrePredict_ROI_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(img, roi,
window=c(0, 100),
xyz=xyz,
text = "Manual\n Segmentation",
text.cex = 2.3
)
dev.off()
file.copy(pngname, file.path(outdir, "SS_Image_PrePredict_ROI_303.png"))
rm(list=ls())
library(fslr)
library(cttools)
library(scales)
homedir = path.expand("~/CT_Registration/Segmentation/")
outdir = path.expand("~/CT_Registration/Oral_Proposal/figure")
datadir = file.path(homedir, "Seg_Figure")
resdir = file.path(homedir, "results")
options(fsl.path='/usr/local/fsl/')
img = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE.nii.gz"),
reorient=FALSE)
ssimg = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_SS_0.01.nii.gz"),
reorient=FALSE)
roi = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINEROI.nii.gz"),
reorient=FALSE)
pred = readNIfTI(file.path(datadir,
"152-303_20060502_0948_CT_2_CT_ROUTINE_mod_agg_Rigid_prediction_native.nii.gz"),
reorient=FALSE)
pred = cal_img(pred > 0.5)
# mask.overlay(img, pred, window=c(0, 100))
# mask.overlay(img, roi, window=c(0, 100))
d = array(0, dim=dim(pred))
d[pred == 1 & roi == 1] = 1
d[pred == 1 & roi == 0] = 2
d[pred == 0 & roi == 1] = 2
plevs = c("Correct Prediction", "Incorrect Prediction")
d = niftiarr(pred, d)
xyz = cog(roi, ceil = TRUE)
pngname = file.path(resdir, "SS_Image_PrePredict_ROI_303.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(img, roi,
window=c(0, 100),
xyz=xyz,
text = "Manual\n Segmentation",
text.cex = 2.3
)
dev.off()
file.copy(pngname, file.path(outdir, "SS_Image_PrePredict_ROI_303.png"))
pngname = file.path(outdir, "SS_Image_PrePredict_ROI_303_Mask.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(roi,
xyz=xyz,
text = "Manual\n Segmentation",
text.cex = 2.3
)
dev.off()
pngname = file.path(outdir, "SS_Image_PrePredict_ROI_303_Mask.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
ortho2(roi,
xyz=xyz,
text = "Manual\n Segmentation Mask",
text.cex = 2.3
)
dev.off()
library(knitcitations)
rm(list=ls())
library(fslr)
library(cttools)
library(scales)
homedir = path.expand("~/CT_Registration/Segmentation/")
outdir = path.expand("~/CT_Registration/Oral_Proposal/figure")
datadir = file.path(homedir, "Seg_Figure")
resdir = file.path(homedir, "results")
rda = file.path(resdir, "Smooth_Model_Cutoffs.Rda")
load(rda)
cutoff = all.scuts["mod_agg"]
img = readNIfTI(file.path(datadir,
"161-413_20110710_1619_CT_2_HEAD_Head.nii.gz"),
reorient=FALSE)
ssimg = readNIfTI(file.path(datadir,
"161-413_20110710_1619_CT_2_HEAD_Head_SS_0.01.nii.gz"),
reorient=FALSE)
ssmask = readNIfTI(file.path(datadir,
"161-413_20110710_1619_CT_2_HEAD_Head_SS_0.01_Mask.nii.gz"),
reorient=FALSE)
roi = readNIfTI(file.path(datadir,
"161-413_20110710_1619_CT_2_HEAD_HeadROI.nii.gz"),
reorient=FALSE)
zval2 = readNIfTI(file.path(datadir,
"161-413_20110710_1619_CT_2_HEAD_Head_zval2.nii.gz"),
reorient=FALSE)
pred = readNIfTI(file.path(datadir,
"161-413_20110710_1619_CT_2_HEAD_Head_mod_agg.nii.gz"),
reorient=FALSE)
pred = pred > cutoff
# mask.overlay(img, pred, window=c(0, 100))
# mask.overlay(img, roi, window=c(0, 100))
d = array(0, dim=dim(pred))
d[pred == 1 & roi == 1] = 1
d[pred == 1 & roi == 0] = 2
d[pred == 0 & roi == 1] = 2
plevs = c("Correct Prediction", "Incorrect Prediction")
d = niftiarr(pred, d)
xyz = cog(roi, ceil = TRUE)
pngname = file.path(resdir, "SS_Image_PrePredict.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
ortho2(ssimg,
window=c(0, 100),
xyz=xyz,
text = "Image",
text.cex = 2.3
)
dev.off()
pngname = file.path(resdir, "SS_Image_PrePredict_ROI.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(ssimg, roi,
window=c(0, 100),
xyz=xyz,
text = "Manual\n Segmentation",
text.cex = 2.3
)
dev.off()
pngname = file.path(resdir, "SS_Image_PrePredict_Auto.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
mask.overlay(ssimg, pred,
window=c(0, 100),
xyz=xyz,
text = "Automatic\n Segmentation",
text.cex = 2.3
)
dev.off()
pngname = file.path(outdir, "Original_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(img, window=c(0, 100), text = "Original Image", xyz=xyz)
dev.off()
thresh =  fslthresh(img, thresh = 0, uthresh = 100,
retimg = TRUE)
pngname = file.path(outdir, "Thresh_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(thresh, window=c(0, 100), text = "Thresholded Image", xyz=xyz)
dev.off()
smooth = fslsmooth(thresh, retimg=TRUE, sigma = 1)
pngname = file.path(outdir, "Smooth_Thresh_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(smooth, window=c(0, 100), text = "Smoothed\nThresholded Image", xyz=xyz)
dev.off()
pngname = file.path(outdir, "SS_Image.png")
png(pngname, res=600, height=7, width=7, units = "in")
ortho2(ssimg, window=c(0, 100), text = "Brain-Extracted\n Image", xyz=xyz)
dev.off()
pngname = file.path(outdir, "SS_Image_PrePredict_ROI_Mask.png")
png(filename = pngname, res=600, height=7, width=7, units= "in")
ortho2(roi,
xyz=xyz,
text = "Manual\n Segmentation Mask",
text.cex = 2.3
)
dev.off()
